<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LPC MUD Development Assistant</title>
  <link href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
  <style>
    :root{--bg:#1e1e1e;--fg:#d4d4d4;--accent:#569cd6;--muted:#6a6a6a}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:Segoe UI, Roboto, Arial}
    .container{max-width:1100px;margin:24px auto;padding:20px;border-radius:8px}
    .header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .select,textarea,button{background:#2a2a2a;color:var(--fg);border:1px solid #333;padding:8px;border-radius:6px}
    .row{display:flex;gap:12px;align-items:center}
    textarea{width:100%;height:220px;resize:vertical;padding:12px;font-family:Consolas,monospace}
    /* allow long tokens or long lines to wrap so the response remains readable */
    #response{white-space:pre-wrap;overflow-wrap:anywhere;word-break:break-word;background:#151515;padding:12px;border-radius:6px;border:1px solid #222;min-height:200px;margin-top:12px}
    .button-accent{background:var(--accent);color:#fff;border:none}
    .small{font-size:12px;color:var(--muted)}
    .toast { position: fixed; right: 16px; top: 16px; padding: 10px 14px; border-radius: 6px; color: #fff; display: none }
    .toast.success { background: #2e7d32 }
    .toast.error { background: #c62828 }
    /* diagnostics toggle (displayed in header) */
    .diag-toggle{position:relative;margin-left:12px;z-index:10001;background:rgba(0,0,0,0.6);color:#fff;border:1px solid #333;padding:6px 8px;border-radius:6px;font-size:12px;cursor:pointer}
    #diagnostics.hidden{display:none}
    pre.code{overflow:auto}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-clike.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-c.min.js"></script>
</head>
<body>
  <script>
    // Tauri API should be injected automatically by the framework
    // If it's not available, the app was opened directly (not via Tauri)
    if (!window.__TAURI__) {
      const el = document.createElement('div');
      el.style.cssText = 'position:fixed;left:0;right:0;top:0;background:#b71c1c;color:#fff;padding:10px;text-align:center;z-index:9999;font-weight:bold';
      el.textContent = '⚠️ Tauri API not injected. Ensure the app runs via cargo tauri dev.';
      document.addEventListener('DOMContentLoaded', ()=>{ document.body.prepend(el); });
    }
  </script>

  <div class="container">
    <div class="header">
      <h2 style="margin:0">LPC MUD Development Assistant</h2>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
        <div class="small">Backend: <span id="backend-status">Checking...</span></div>
        <button id="diag-toggle" class="diag-toggle" title="Toggle diagnostics">Diag</button>
      </div>
    </div>

    <label class="small">Ask a question (uses project references)</label>
    <textarea id="question" placeholder="Ask about driver implementation, efuns, or paste a code snippet to search references"></textarea>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="ask-btn" class="button-accent">Ask</button>
      <button id="clear-btn" class="select">Clear</button>
      <div style="flex:1" class="small">Simple: type, press Ask, view answer and sources below.</div>
    </div>

    <div id="response" aria-live="polite">Response will appear here</div>
    <div id="sources" class="small" style="margin-top:12px">Sources: none</div>
    <div class="footer" style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
      <div>
        <button id="copy-btn" class="select">Copy Answer</button>
      </div>
      <div id="status-msg" class="small">Ready</div>
    </div>

    <div id="toast" class="toast"></div>
  </div>

    <!-- Runtime diagnostics (helps detect whether app is running inside Tauri webview) -->
    <div id="diagnostics" class="hidden" style="position:fixed;right:12px;top:48px;background:rgba(0,0,0,0.6);color:#fff;padding:8px;border-radius:6px;font-size:12px;z-index:10000;max-width:320px;line-height:1.2">
      <div><strong>Runtime diagnostics</strong></div>
      <div id="diag-origin">origin: </div>
      <div id="diag-ua">ua: </div>
      <div id="diag-tauri">__TAURI__: </div>
    </div>

  <script>
  function safeStorage(){
    try{ localStorage.setItem('__ok__','1'); localStorage.removeItem('__ok__'); return localStorage;}catch(e){try{sessionStorage.setItem('__ok__','1');sessionStorage.removeItem('__ok__');return sessionStorage}catch(e){return null}}
  }

  function showToast(text, kind='success'){ const t=document.getElementById('toast'); if(!t) return; t.textContent=text; t.className='toast '+kind; t.style.display='block'; setTimeout(()=>t.style.display='none',4000); }

  document.addEventListener('DOMContentLoaded', function initUI(){
    (async function(){
      // wait briefly for Tauri to inject its API (avoid race where DOMContentLoaded fires too early)
      const waitForTauri = async (timeout = 2000, interval = 100) => {
        const start = Date.now();
        while (Date.now() - start < timeout) {
          if (window.__TAURI__) return true;
          await new Promise(r => setTimeout(r, interval));
        }
        return !!window.__TAURI__;
      };

      const tauriReady = await waitForTauri();
      console.log('tauriReady:', tauriReady, 'window.__TAURI__ keys:', window.__TAURI__ ? Object.keys(window.__TAURI__) : null);
      // populate runtime diagnostics box
      try{
        const elOrigin = document.getElementById('diag-origin'); if(elOrigin) elOrigin.textContent = 'origin: '+location.href;
        const elUA = document.getElementById('diag-ua'); if(elUA) elUA.textContent = 'ua: '+(navigator.userAgent||'');
        const elT = document.getElementById('diag-tauri'); if(elT) elT.textContent = '__TAURI__: '+(!!window.__TAURI__);
      }catch(e){console.warn('diag update failed', e)}

      // diagnostics toggle state (persist in localStorage when available)
      try{
        const diagEl = document.getElementById('diagnostics');
        const toggleBtn = document.getElementById('diag-toggle');
        const storage = safeStorage();
        const stored = storage ? storage.getItem('diagVisible') : null;
        const visible = stored === '1';
        if(diagEl){ if(visible) diagEl.classList.remove('hidden'); else diagEl.classList.add('hidden'); }
        if(toggleBtn){ toggleBtn.addEventListener('click', ()=>{
          if(!diagEl) return;
          const isHidden = diagEl.classList.toggle('hidden');
          if(storage) storage.setItem('diagVisible', isHidden ? '0' : '1');
        }); }
      }catch(e){console.warn('diag toggle init failed', e)}

      // Tauri invoke helper
      const invoke = window.__TAURI__?.core?.invoke || window.__TAURI__?.invoke || function(){ return Promise.reject(new Error('Tauri invoke not available')); };

      const askBtn = document.getElementById('ask-btn');
      const clearBtn = document.getElementById('clear-btn');
      const copyBtn = document.getElementById('copy-btn');
      const responseEl = document.getElementById('response');
      const sourcesEl = document.getElementById('sources');
      const statusMsg = document.getElementById('status-msg');
      const backendStatus = document.getElementById('backend-status');

      let defaultModel = 'qwen2.5-coder:3b';

      async function initBackend() {
        try{
          const models = await invoke('list_models');
          if(Array.isArray(models) && models.length>0){ defaultModel = models[0]; backendStatus.textContent = 'Connected'; backendStatus.style.color = '#8f8'; }
          else { backendStatus.textContent = 'No models'; backendStatus.style.color = '#fa6'; }
        }catch(e){ backendStatus.textContent = 'Disconnected'; backendStatus.style.color = '#f66'; console.warn('list_models failed', e); }
      }

      async function doAsk(){
        const question = document.getElementById('question')?.value || '';
        if(!question.trim()){ showToast('Enter a question','error'); return; }
        statusMsg.textContent = 'Searching references...'; responseEl.textContent = '';

        // Get top sources from index
        let sources = [];
        try{
          sources = await invoke('search_examples', { keyword: question });
        }catch(e){ console.warn('search_examples failed', e); }

        if(Array.isArray(sources) && sources.length>0){
          sourcesEl.textContent = 'Sources: ' + sources.slice(0,5).join(', ');
        } else {
          sourcesEl.textContent = 'Sources: (none)';
        }

        statusMsg.textContent = 'Asking model...';
        try{
          const answer = await invoke('ask_ollama', { model: defaultModel, question: question, context_type: 'references' });
          responseEl.textContent = answer || '(no response)';
          statusMsg.textContent = 'Done';
        }catch(e){
          responseEl.textContent = 'ERROR: ' + (e?.message || String(e));
          statusMsg.textContent = 'Error';
          showToast('Request failed','error');
        }
      }

      askBtn?.addEventListener('click', doAsk);
      clearBtn?.addEventListener('click', ()=>{ document.getElementById('question').value=''; responseEl.textContent=''; sourcesEl.textContent='Sources: none'; statusMsg.textContent='Ready'; });
      copyBtn?.addEventListener('click', ()=>{ try{ navigator.clipboard.writeText(responseEl.textContent||''); showToast('Copied','success'); }catch(e){ showToast('Copy failed','error'); } });

      initBackend();
    })();
  });
  </script>
</body>
</html>