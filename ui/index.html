<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LPC MUD Development Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    :root {
      --bg: #0f141a;
      --panel: #161d26;
      --panel-2: #1d2633;
      --text: #e8edf4;
      --muted: #98a7b8;
      --accent: #0ea5e9;
      --accent-2: #06b6d4;
      --border: #223140;
      --shadow: 0 12px 40px rgba(0,0,0,0.4);
      --success: #34d399;
      --warning: #fbbf24;
      --error: #f87171;
      --code: #0b1016;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: radial-gradient(circle at 20% 20%, rgba(14,165,233,0.05), transparent 25%),
                  radial-gradient(circle at 80% 10%, rgba(6,182,212,0.05), transparent 22%),
                  var(--bg);
      color: var(--text);
      font-family: "Sora", "SF Pro Display", "Inter", sans-serif;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 28px;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(8px);
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(15,20,26,0.95);
    }

    .title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--panel-2);
      border: 1px solid var(--border);
      color: var(--muted);
      font-size: 12px;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .select, .input, textarea {
      background: var(--panel);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
    }

    textarea {
      width: 100%;
      min-height: 160px;
      resize: vertical;
      font-family: "JetBrains Mono", "Consolas", monospace;
      background: var(--panel-2);
    }

    .grid {
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 18px;
      padding: 18px 24px 32px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      font-weight: 700;
      letter-spacing: 0.2px;
    }

    .subgrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }

    .control {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
    }

    label span {
      color: var(--text);
      font-weight: 600;
    }

    .slider-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    input[type="range"] {
      flex: 1;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s ease, border-color 0.2s ease, background 0.2s ease;
    }

    button.primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); border: none; color: #0b1016; }
    button:hover { transform: translateY(-1px); border-color: var(--accent); }
    button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .response {
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      min-height: 260px;
      overflow-y: auto;
    }

    .markdown-body {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text);
    }

    .markdown-body pre { background: var(--code); padding: 12px; border-radius: 10px; overflow-x: auto; }
    .markdown-body code { background: rgba(255,255,255,0.04); padding: 2px 4px; border-radius: 6px; }

    .chip-row { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
    .chip { background: var(--panel-2); border: 1px solid var(--border); border-radius: 999px; padding: 4px 10px; color: var(--muted); font-size: 12px; }

    .metric-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-top: 6px; }
    .metric-card { background: var(--panel-2); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.03); }
    .metric-title { font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; align-items: center; }
    .metric-value { font-size: 18px; font-weight: 700; margin-top: 6px; display: flex; align-items: baseline; gap: 6px; }
    .metric-sub { font-size: 12px; color: var(--muted); }
    .score-pill { display: inline-flex; align-items: center; gap: 8px; padding: 10px 12px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #0b1016; border-radius: 12px; font-weight: 700; box-shadow: var(--shadow); }
    .issue-list { list-style: none; padding: 0; margin: 8px 0 0; display: flex; flex-direction: column; gap: 6px; }
    .issue-item { padding: 10px 12px; border-radius: 10px; background: var(--panel-2); border: 1px solid var(--border); color: var(--muted); }
    .issue-item.bad { border-color: var(--error); color: #fecdd3; }
    .issue-item.good { border-color: var(--success); color: #d1fae5; }
    .badge { padding: 4px 8px; border-radius: 999px; font-size: 11px; border: 1px solid var(--border); background: var(--panel); color: var(--muted); }
    .badge.ok { border-color: var(--success); color: var(--success); }
    .badge.warn { border-color: var(--warning); color: var(--warning); }
    .badge.err { border-color: var(--error); color: var(--error); }

    .source-list { list-style: none; margin: 0; padding: 0; display: flex; flex-direction: column; gap: 8px; }
    .source-item { padding: 10px; border: 1px solid var(--border); border-radius: 10px; background: var(--panel-2); }
    .source-score { color: var(--accent); font-weight: 700; font-size: 12px; }

    .status { font-size: 13px; color: var(--muted); display: flex; align-items: center; gap: 8px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--warning); box-shadow: 0 0 0 4px rgba(251,191,36,0.12); }
    .dot.ok { background: var(--success); box-shadow: 0 0 0 4px rgba(52,211,153,0.12); }
    .dot.err { background: var(--error); box-shadow: 0 0 0 4px rgba(248,113,113,0.12); }

    .toolbar { display: flex; align-items: center; gap: 10px; }
    .tag { font-size: 12px; color: var(--muted); }

    .copy-btn {
      float: right;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .prompt-container {
      position: relative;
    }

    .copy-prompt-btn {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      z-index: 5;
      transition: all 0.2s ease;
    }

    .copy-prompt-btn:hover {
      background: var(--panel-2);
      color: var(--accent);
      border-color: var(--accent);
    }

    .toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: var(--panel-2);
      border: 1px solid var(--border);
      padding: 12px 14px;
      border-radius: 10px;
      color: var(--text);
      box-shadow: var(--shadow);
      display: none;
    }

    @media (max-width: 1100px) {
      .grid { grid-template-columns: 1fr; }
    }

    /* Tab styling */
    .tabs-header {
      display: flex;
      gap: 8px;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(15,20,26,0.95);
      overflow-x: auto;
      scroll-behavior: smooth;
    }

    .tab-btn {
      padding: 8px 14px;
      border: 1px solid var(--border);
      background: var(--panel-2);
      color: var(--muted);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .tab-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border: none;
      color: #0b1016;
    }

    .tab-content {
      display: none;
      padding: 18px 24px;
      min-height: 500px;
    }

    .tab-content.active {
      display: block;
    }

    .tab-content .card {
      margin-bottom: 18px;
    }

    .action-btn {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      border: none;
      color: #0b1016;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      transition: transform 0.1s ease;
    }

    .action-btn:hover {
      transform: translateY(-2px);
    }

    .action-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div>
        <div>LPC Dev Assistant</div>
        <div class="tag">Markdown rendering, model controls, RAG preview</div>
      </div>
    </div>
    <div class="controls">
      <div class="status" id="conn-status"><span class="dot"></span><span id="status-text">Connecting…</span></div>
      <select id="model-select" class="select"></select>
      <button id="refresh-models">Refresh Models</button>
    </div>
  </header>

  <div class="tabs-header">
    <button class="tab-btn active" data-tab="assistant">Assistant</button>
    <button class="tab-btn" data-tab="driver">Driver</button>
  </div>

  <!-- Assistant Tab (Main content) -->
  <div id="assistant" class="tab-content active">
    <div class="grid">
      <div class="card">
      <div class="section-title">
        <span>Prompt</span>
        <div class="toolbar">
          <span class="tag">Ctrl+Enter to send</span>
        </div>
      </div>
      <div class="prompt-container">
        <textarea id="question" placeholder="Ask about driver, efuns, mudlib patterns, or paste code for guidance."></textarea>
        <button class="copy-prompt-btn" id="copy-prompt-btn">Copy</button>
      </div>
      <div class="btn-row" style="margin-top:12px;">
        <button class="primary" id="ask-btn">Ask</button>
        <button id="stop-btn">Stop</button>
        <button id="clear-btn">Clear</button>
      </div>

      <div class="section-title" style="margin-top:18px;">Generation Settings</div>
      <div class="subgrid">
        <div class="control">
          <label><span>Temperature</span> <small id="temp-val">0.3</small></label>
          <div class="slider-row">
            <input type="range" id="temperature" min="0" max="1" step="0.05" value="0.3">
          </div>
        </div>
        <div class="control">
          <label><span>Top P</span> <small id="top-p-val">0.9</small></label>
          <input type="range" id="top-p" min="0" max="1" step="0.05" value="0.9">
        </div>
        <div class="control">
          <label><span>Top K</span> <small id="top-k-val">40</small></label>
          <input type="range" id="top-k" min="1" max="200" step="1" value="40">
        </div>
        <div class="control">
          <label><span>Max Tokens</span> <small id="num-predict-val">4096</small></label>
          <input type="range" id="num-predict" min="256" max="8192" step="256" value="4096">
        </div>
      </div>

      <div class="control" style="margin-top:10px;">
        <label><span>System Prompt</span></label>
        <textarea id="system-prompt" placeholder="Optional: override or prepend behavior instructions."></textarea>
      </div>

      <div class="btn-row" style="margin-top:10px;">
        <label class="control" style="flex-direction:row; align-items:center; gap:8px;">
          <input type="checkbox" id="rag-toggle" checked />
          <span>Use reference retrieval (RAG)</span>
        </label>
      </div>
    </div>

    <div class="card">
      <div class="section-title">
        <span>Response</span>
        <div class="btn-row">
          <button id="copy-response">Copy</button>
        </div>
      </div>
      <div class="chip-row" id="meta-row">
        <span class="chip" id="meta-model">Model: -</span>
        <span class="chip" id="meta-latency">Latency: -</span>
      </div>
      <div class="response">
        <div id="response-markdown" class="markdown-body">Waiting for a prompt.</div>
      </div>

      <div class="section-title" style="margin-top:14px;">Validation</div>
      <div class="metric-grid">
        <div class="metric-card">
          <div class="metric-title">Header compliance <span id="header-badge" class="badge">-</span></div>
          <div class="metric-value" id="header-status">Pending</div>
          <div class="metric-sub">Expect vm.h, codegen.h</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Opcode usage</div>
          <div class="metric-value"><span id="opcode-count">0</span><span class="metric-sub">unique OP_*</span></div>
          <div class="metric-sub" id="opcode-meta">Awaiting run</div>
        </div>
        <div class="metric-card">
          <div class="metric-title">Quality score</div>
          <div class="metric-value"><span id="quality-score">-</span><span class="metric-sub">/10</span></div>
          <div class="metric-sub" id="quality-meta">Pending analysis</div>
        </div>
      </div>
      <ul id="issue-list" class="issue-list"><li class="issue-item">No validation issues yet.</li></ul>

      <div class="section-title" style="margin-top:14px;">Test Scoring</div>
      <div class="score-pill" id="score-pill">Score: --</div>
      <div class="metric-sub" id="scoring-note">Waiting for generation.</div>

      <div class="section-title" style="margin-top:14px;">RAG Debug (Top 15)</div>
      <ul class="source-list" id="context-list">
        <li class="source-item">No references yet.</li>
      </ul>

      <div class="section-title" style="margin-top:14px;">Status</div>
      <div id="status-bar" class="status">Ready.</div>
    </div>
    </div>
  </div>
  <!-- End Assistant Tab -->

  <!-- Driver Tab -->
  <div id="driver" class="tab-content">
    <div class="card">
      <h3 style="margin-top: 0;">AMLP Driver Integration</h3>
      <p style="color: var(--muted); font-size: 14px;">Test WSL command execution and LPC file compilation.</p>
    </div>

    <div class="card">
      <h3>Connection Test</h3>
      <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">Verify that the driver is accessible via WSL</p>
      <button id="test-connection-btn" class="action-btn">Test Driver Connection</button>
      <pre id="connection-status" style="margin-top: 10px; padding: 10px; background: var(--code); border-radius: 4px; border: 1px solid var(--border); max-height: 200px; overflow-y: auto; color: var(--muted); font-size: 12px;">Ready to test...</pre>
    </div>

    <div class="card">
      <h3>Compile LPC File</h3>
      <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">Compile an LPC file using the amlp-driver</p>
      <label style="display: block; margin-bottom: 6px; color: var(--text); font-weight: 600;">File Path (WSL):</label>
      <input type="text" id="lpc-file-path" placeholder="/home/thurtea/amlp-library/master.c" style="width: 100%; margin-bottom: 12px; background: var(--panel); color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 10px; font-family: 'JetBrains Mono', monospace; font-size: 13px;">
      <button id="compile-btn" class="action-btn">Compile File</button>
      <pre id="compile-output" style="margin-top: 10px; padding: 10px; background: var(--code); border-radius: 4px; border: 1px solid var(--border); max-height: 300px; overflow-y: auto; color: var(--muted); font-size: 12px;">Ready to compile...</pre>
    </div>

    <div class="card">
      <h3>Build Driver UI</h3>
      <p style="color: var(--muted); font-size: 13px; margin-bottom: 12px;">Run the styled terminal UI build system</p>
      <button id="build-ui-btn" class="action-btn">Run make build-ui</button>
      <pre id="build-output" style="margin-top: 10px; padding: 10px; background: var(--code); border-radius: 4px; border: 1px solid var(--border); max-height: 400px; overflow-y: auto; color: var(--muted); font-size: 12px;">Ready to build...</pre>
    </div>
  </div>
  <!-- End Driver Tab -->

  <div id="toast" class="toast"></div>

  <script>
    const store = (() => {
      try { return window.localStorage; } catch { return null; }
    })();

    const state = {
      currentModel: '',
      loading: false,
      cancelToken: 0,
      lastMetrics: null,
    };

    const settingsDefaults = {
      temperature: 0.3,
      top_p: 0.9,
      top_k: 40,
      num_predict: 4096,
      rag: true,
      system_prompt: ''
    };

    const emptyMetrics = {
      headerCompliance: false,
      opcodeCount: 0,
      issues: [],
      score: null,
      callMethodUse: false,
      hasCodegenEmit: false,
    };

    function analyzeResponse(answer) {
      const text = answer || '';
      const codeFenceCount = (text.match(/```/g) || []).length / 2;
      const hasFence = codeFenceCount >= 1;
      const lengthOk = text.trim().length >= 200;
      const hasInclude = /#include\s+[<"]/i.test(text);
      const hasFunction = /\b(void|int|static|char|struct)\s+[A-Za-z_][A-Za-z0-9_]*\s*\(/.test(text);
      const qualitySignals = ["struct", "switch", "return", "efun", "object", "call_other", "CALL_METHOD", "apply", "opcode", "emit"]; 
      const signalCount = qualitySignals.reduce((acc, sig) => acc + (text.includes(sig) ? 1 : 0), 0);

      const issues = [];
      if (!lengthOk) issues.push("Response too short (<200 chars)");
      if (!hasFence) issues.push("No code block detected");
      if (!hasFunction) issues.push("No function signatures detected");
      if (!hasInclude) issues.push("No includes or headers referenced");

      const base = 10 - issues.length * 1.5;
      const bonus = (hasFence ? 0.6 : 0) + (hasInclude ? 0.4 : 0) + (hasFunction ? 0.6 : 0) + Math.min(signalCount, 8) * 0.25;
      const score = Math.max(0, Math.min(10, base + bonus));

      return {
        headerCompliance: issues.length === 0,
        opcodeCount: signalCount,
        issues,
        score: Number(score.toFixed(1)),
        callMethodUse: hasFunction,
        hasCodegenEmit: hasFence,
      };
    }

    function renderValidation(metrics = emptyMetrics) {
      const headerBadge = document.getElementById('header-badge');
      const headerStatus = document.getElementById('header-status');
      const opcodeCount = document.getElementById('opcode-count');
      const opcodeMeta = document.getElementById('opcode-meta');
      const qualityScore = document.getElementById('quality-score');
      const qualityMeta = document.getElementById('quality-meta');
      const issueList = document.getElementById('issue-list');
      if (!headerBadge || !headerStatus || !opcodeCount || !issueList) return;

      headerBadge.textContent = metrics.headerCompliance ? 'Ready' : 'Needs review';
      headerBadge.className = `badge ${metrics.headerCompliance ? 'ok' : 'err'}`;
      headerStatus.textContent = metrics.headerCompliance ? 'Structure looks valid' : 'Add code fences and functions';
      opcodeCount.textContent = metrics.opcodeCount;
      opcodeMeta.textContent = metrics.callMethodUse ? 'Functions detected' : 'Add function definitions';
      qualityScore.textContent = (typeof metrics.score === 'number') ? metrics.score.toFixed(1) : '--';
      qualityMeta.textContent = metrics.headerCompliance ? 'Validated' : 'Pending fixes';

      issueList.innerHTML = '';
      if (!metrics.issues || metrics.issues.length === 0) {
        issueList.innerHTML = '<li class="issue-item good">No validation issues detected.</li>';
      } else {
        metrics.issues.forEach(issue => {
          const li = document.createElement('li');
          li.className = 'issue-item bad';
          li.textContent = issue;
          issueList.appendChild(li);
        });
      }
    }

    function renderScorePill(metrics = emptyMetrics) {
      const pill = document.getElementById('score-pill');
      const note = document.getElementById('scoring-note');
      if (!pill || !note) return;
      pill.textContent = `Score: ${(typeof metrics.score === 'number') ? metrics.score.toFixed(1) : '--'}/10`;
      note.textContent = `${metrics.opcodeCount} signals · ${metrics.headerCompliance ? 'Looks good' : 'Needs attention'}`;
    }

    function persistSettings() {
      if (!store) return;
      const payload = {
        temperature: parseFloat(document.getElementById('temperature').value),
        top_p: parseFloat(document.getElementById('top-p').value),
        top_k: parseInt(document.getElementById('top-k').value, 10),
        num_predict: parseInt(document.getElementById('num-predict').value, 10),
        rag: document.getElementById('rag-toggle').checked,
        system_prompt: document.getElementById('system-prompt').value || ''
      };
      store.setItem('lpc-settings', JSON.stringify(payload));
    }

    function loadSettings() {
      const raw = store?.getItem('lpc-settings');
      const data = raw ? { ...settingsDefaults, ...JSON.parse(raw) } : settingsDefaults;
      document.getElementById('temperature').value = data.temperature;
      document.getElementById('top-p').value = data.top_p;
      document.getElementById('top-k').value = data.top_k;
      document.getElementById('num-predict').value = data.num_predict;
      document.getElementById('rag-toggle').checked = data.rag;
      document.getElementById('system-prompt').value = data.system_prompt;
      updateSliderLabels();
    }

    function updateSliderLabels() {
      document.getElementById('temp-val').textContent = document.getElementById('temperature').value;
      document.getElementById('top-p-val').textContent = document.getElementById('top-p').value;
      document.getElementById('top-k-val').textContent = document.getElementById('top-k').value;
      document.getElementById('num-predict-val').textContent = document.getElementById('num-predict').value;
    }

    function setStatus(text, kind = 'info') {
      const el = document.getElementById('status-bar');
      const status = document.getElementById('status-text');
      const dot = document.querySelector('.status .dot');
      if (el) el.textContent = text;
      if (status) status.textContent = text;
      if (dot) {
        dot.classList.remove('ok', 'err');
        if (kind === 'success') dot.classList.add('ok');
        if (kind === 'error') dot.classList.add('err');
      }
    }

    function toast(text) {
      const el = document.getElementById('toast');
      if (!el) return;
      el.textContent = text;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 3200);
    }

    function renderMarkdown(text) {
      const md = document.getElementById('response-markdown');
      if (!md) return;
      const html = marked.parse(text || '');
      md.innerHTML = html;
      md.querySelectorAll('pre code').forEach(block => {
        hljs.highlightElement(block);
        const btn = document.createElement('button');
        btn.textContent = 'Copy code';
        btn.className = 'copy-btn';
        btn.addEventListener('click', () => {
          navigator.clipboard.writeText(block.textContent || '');
          toast('Code block copied');
        });
        block.parentElement.insertBefore(btn, block);
      });
    }

    async function loadModels() {
      const select = document.getElementById('model-select');
      if (!select) return;
      select.innerHTML = '<option>Loading models…</option>';
      try {
        const models = await (window.__TAURI__?.core?.invoke || window.__TAURI__?.invoke)('get_available_models');
        select.innerHTML = '';
        if (Array.isArray(models) && models.length) {
          models.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m; opt.textContent = m; select.appendChild(opt);
          });
          const saved = store?.getItem('lpc-model');
          if (saved && models.includes(saved)) select.value = saved;
          state.currentModel = select.value;
          document.getElementById('meta-model').textContent = `Model: ${state.currentModel}`;
          setStatus('Ready', 'success');
        } else {
          select.innerHTML = '<option>No models found</option>';
          setStatus('No models available', 'error');
        }
      } catch (e) {
        console.error(e);
        select.innerHTML = '<option>Error loading models</option>';
        setStatus('Cannot reach Ollama', 'error');
      }
    }

    function renderContext(results) {
      const list = document.getElementById('context-list');
      if (!list) return;
      if (!results || !results.length) {
        list.innerHTML = '<li class="source-item">No references found.</li>';
        return;
      }
      list.innerHTML = results.map((r, idx) => `
        <li class="source-item">
          <div class="source-score">#${idx + 1} • ${((r.relevance_score || 0) * 100).toFixed(1)}%</div>
          <div>${r.path}${r.line_number !== undefined ? `:${r.line_number + 1}` : ''}</div>
          <pre style="white-space:pre-wrap; margin-top:6px;">${r.snippet}</pre>
        </li>`).join('');
    }

    async function fetchContext(question) {
      try {
        const results = await (window.__TAURI__?.core?.invoke || window.__TAURI__?.invoke)('search_references', { query: question, limit: 15 });
        renderContext(results);
      } catch (e) {
        console.warn('context fetch failed', e);
        renderContext([]);
      }
    }

    async function sendPrompt() {
      const q = (document.getElementById('question').value || '').trim();
      if (!q) { toast('Enter a prompt first'); return; }
      if (state.loading) { toast('Already running'); return; }

      const rag = document.getElementById('rag-toggle').checked;
      const systemPrompt = document.getElementById('system-prompt').value || '';
      const payloadQuestion = systemPrompt ? `${systemPrompt}\n\n${q}` : q;

      const opts = {
        model: document.getElementById('model-select').value,
        question: payloadQuestion,
        context_type: rag ? 'references' : null,
        temperature: parseFloat(document.getElementById('temperature').value),
        top_p: parseFloat(document.getElementById('top-p').value),
        top_k: parseInt(document.getElementById('top-k').value, 10),
        num_predict: parseInt(document.getElementById('num-predict').value, 10)
      };

      state.loading = true;
      state.cancelToken += 1;
      const token = state.cancelToken;
      setStatus('Generating...', 'warning');
      const started = performance.now();
      renderMarkdown('');
      renderValidation(emptyMetrics);
      renderScorePill(emptyMetrics);

      if (rag) fetchContext(q);
      persistSettings();
      store?.setItem('lpc-model', opts.model);
      document.getElementById('meta-model').textContent = `Model: ${opts.model}`;

      try {
        const answer = await (window.__TAURI__?.core?.invoke || window.__TAURI__?.invoke)('ask_ollama', opts);
        if (token !== state.cancelToken) return; // cancelled
        renderMarkdown(answer || '');
        const metrics = analyzeResponse(answer || '');
        state.lastMetrics = metrics;
        renderValidation(metrics);
        renderScorePill(metrics);
        const latency = performance.now() - started;
        document.getElementById('meta-latency').textContent = `Latency: ${latency.toFixed(0)} ms`;
        setStatus('Complete', 'success');
      } catch (e) {
        if (token !== state.cancelToken) return;
        renderMarkdown(`**Error:** ${e?.message || e}`);
        renderValidation(emptyMetrics);
        renderScorePill(emptyMetrics);
        setStatus('Error running generation', 'error');
      } finally {
        state.loading = false;
      }
    }

    async function stopGeneration() {
      state.cancelToken += 1;
      try {
        await (window.__TAURI__?.core?.invoke || window.__TAURI__?.invoke)('stop_generation');
      } catch (e) {
        console.warn('stop_generation failed', e);
      }
      setStatus('Stopped', 'warning');
    }

    function bindEvents() {
      ['temperature','top-p','top-k','num-predict'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
          updateSliderLabels();
          persistSettings();
        });
      });
      document.getElementById('system-prompt').addEventListener('input', persistSettings);
      document.getElementById('rag-toggle').addEventListener('change', persistSettings);
      document.getElementById('ask-btn').addEventListener('click', sendPrompt);
      document.getElementById('clear-btn').addEventListener('click', () => {
        document.getElementById('question').value = '';
        renderMarkdown('Cleared.');
        renderValidation(emptyMetrics);
        renderScorePill(emptyMetrics);
        renderContext([]);
        setStatus('Ready');
      });
      document.getElementById('copy-response').addEventListener('click', () => {
        const text = document.getElementById('response-markdown').innerText || '';
        navigator.clipboard.writeText(text);
        toast('Response copied');
      });
      document.getElementById('refresh-models').addEventListener('click', loadModels);
      document.getElementById('model-select').addEventListener('change', (e) => {
        state.currentModel = e.target.value;
        store?.setItem('lpc-model', state.currentModel);
        document.getElementById('meta-model').textContent = `Model: ${state.currentModel}`;
      });
      document.getElementById('stop-btn').addEventListener('click', stopGeneration);
      document.getElementById('question').addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') sendPrompt();
      });
      document.getElementById('copy-prompt-btn').addEventListener('click', () => {
        const promptText = document.getElementById('question').value || '';
        if (!promptText.trim()) {
          toast('No prompt to copy');
          return;
        }
        navigator.clipboard.writeText(promptText);
        toast('Prompt copied!');
      });
    }



    document.addEventListener('DOMContentLoaded', async () => {
      loadSettings();
      bindEvents();
      renderValidation(emptyMetrics);
      renderScorePill(emptyMetrics);
      
      // Check setup status on startup
      await checkSetup();
      await checkAndStartOllama();
      
      await loadModels();
      setStatus('Ready', 'success');
    });

    async function checkAndStartOllama() {
      try {
        const available = await window.__TAURI__.invoke('check_ollama_available');
        if (!available) {
          const start = confirm('Ollama is not running. Would you like to start it?');
          if (start) {
            await window.__TAURI__.invoke('start_ollama_service');
            await new Promise(r => setTimeout(r, 3000));
            const nowAvailable = await window.__TAURI__.invoke('check_ollama_available');
            if (nowAvailable) {
              alert('Ollama started successfully!');
              location.reload();
            } else {
              alert('Failed to start Ollama. Please start it manually.');
            }
          }
        }
      } catch (e) {
        console.warn('Ollama availability check failed', e);
      }
    }

    async function checkSetup() {
      try {
        const status = await (window.__TAURI__?.core?.invoke || window.__TAURI__?.invoke)('get_setup_status');
        
        if (!status.ollama_installed) {
          const startOllama = confirm(
            'Ollama not detected!\n\n' +
            'LPC Dev Assistant requires Ollama to be installed and running.\n\n' +
            'Would you like to start Ollama now?\n\n' +
            'Click OK to start "ollama serve", or Cancel to continue without it.'
          );
          if (startOllama) {
            try {
              setStatus('Starting Ollama...', 'info');
              await (window.__TAURI__?.core?.invoke || window.__TAURI__?.invoke)('start_ollama');
              toast('Starting Ollama... Please wait.');
              // Poll for availability up to ~8 seconds
              for (let i = 0; i < 4; i++) {
                await new Promise(resolve => setTimeout(resolve, 2000));
                try {
                  await (window.__TAURI__?.core?.invoke || window.__TAURI__?.invoke)('check_ollama_health');
                  setStatus('Ready', 'success');
                  break;
                } catch (pollErr) {
                  if (i === 3) {
                    throw pollErr;
                  }
                  setStatus('Connecting to Ollama...', 'info');
                }
              }
            } catch (e) {
              const proceed = confirm(
                'Failed to confirm Ollama startup: ' + e + '\n\n' +
                'Please start Ollama manually by running "ollama serve" in a terminal.\n\n' +
                'Click OK to continue anyway.'
              );
              if (!proceed) {
                window.close();
                return;
              }
            }
          }
        }
        
        if (status.first_run && !status.index_built) {
          const runSetup = confirm(
            'First Run Setup\n\n' +
            'The application needs to extract reference archives and build the search index.\n' +
            'This may take a few minutes.\n\n' +
            'Click OK to run setup now.'
          );
          
          if (runSetup) {
            setStatus('Running initial setup...', 'warning');
            try {
              const result = await (window.__TAURI__?.core?.invoke || window.__TAURI__?.invoke)('run_initial_setup');
              toast(result);
              await (window.__TAURI__?.core?.invoke || window.__TAURI__?.invoke)('mark_setup_complete');
              setStatus('Setup complete', 'success');
            } catch (e) {
              setStatus('Setup failed: ' + e, 'error');
              toast('Setup failed. Some features may not work.');
            }
          }
        }
      } catch (e) {
        console.warn('Setup check failed', e);
      }
    }

    // Tab switching
    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
      
      // Show selected tab
      const tabEl = document.getElementById(tabName);
      if (tabEl) tabEl.classList.add('active');
      
      // Mark button as active
      const btnEl = document.querySelector(`[data-tab="${tabName}"]`);
      if (btnEl) btnEl.classList.add('active');
    }

    // Tab button click handlers
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        if (tabName) switchTab(tabName);
      });
    });

    // Driver tab event handlers
    document.getElementById('test-connection-btn')?.addEventListener('click', async () => {
      const statusEl = document.getElementById('connection-status');
      statusEl.textContent = 'Testing connection...';
      statusEl.style.color = 'var(--muted)';
      try {
        const result = await window.__TAURI_INVOKE__('test_driver_connection');
        statusEl.textContent = result;
        statusEl.style.color = '#4ade80';
      } catch (error) {
        statusEl.textContent = `Error: ${error}`;
        statusEl.style.color = '#ef4444';
      }
    });

    document.getElementById('compile-btn')?.addEventListener('click', async () => {
      const outputEl = document.getElementById('compile-output');
      const filePath = document.getElementById('lpc-file-path').value.trim();
      
      if (!filePath) {
        outputEl.textContent = 'Please enter a file path';
        outputEl.style.color = '#ef4444';
        return;
      }
      
      outputEl.textContent = 'Compiling...';
      outputEl.style.color = 'var(--muted)';
      try {
        const result = await window.__TAURI_INVOKE__('compile_lpc', { file_path: filePath });
        const stdout = (result.stdout || []).join('\n');
        const stderr = (result.stderr || []).join('\n');
        const output = stdout || stderr || '(no output)';
        
        if (result.success) {
          outputEl.textContent = `✅ Success! (exit code ${result.exit_code})\n\n${output}`;
          outputEl.style.color = '#4ade80';
        } else {
          outputEl.textContent = `❌ Compilation failed (exit code ${result.exit_code})\n\n${output}`;
          outputEl.style.color = '#ef4444';
        }
      } catch (error) {
        outputEl.textContent = `Error: ${error}`;
        outputEl.style.color = '#ef4444';
      }
    });

    document.getElementById('build-ui-btn')?.addEventListener('click', async () => {
      const outputEl = document.getElementById('build-output');
      outputEl.textContent = 'Building...';
      outputEl.style.color = 'var(--muted)';
      try {
        const result = await window.__TAURI_INVOKE__('build_driver_ui');
        outputEl.textContent = result;
        outputEl.style.color = '#4ade80';
      } catch (error) {
        outputEl.textContent = `Error: ${error}`;
        outputEl.style.color = '#ef4444';
      }
    });
  </script>
</body>
</html>
